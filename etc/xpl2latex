#!/bin/sh
#############################################################################
##
#W  xpl2latex                  GAP utilities                    Thomas Breuer
##
#H  @(#)$Id$
##
#Y  Copyright (C)  1999,  Lehrstuhl D fuer Mathematik,  RWTH Aachen,  Germany
##
##  This script produces a LaTeX version from an example file.
##
##  It must be called from the tst directory of GAP.
##
##  Each block of lines between \beginexample and \endexample is put
##  into verbatim style, the lines are indented by 4 characters.
##  The same holds for lines between \begintt and \endtt.
##  (\begin and \end must occur in the beginning of the lines.)
##
##  Text not contained in examples and enclosed in backquote/singlequote
##  pairs is set in verbatim, a backquote can be escaped with a backslash.
##  (This part of the conversion is done by the script xpl2latex.awk
##  because when it appears here it must be included in singlequotes,
##  and then the shell regards the singlequotes in the script as separators.)
##
##  Text not contained in examples and enclosed in stars is set
##  in boldface, a star can be escaped with a backslash.
##
#T something about header and footer!
##
awk -v "INFILE=$1" \
    'BEGIN {
        printf( "%% This file was created from %s, do not edit!\n", INFILE );
    bf = 0
}

# Simply copy everything if a line does not match.
! /^\\beginexample/ && ! /^\\begintt/ && ! /\*/ {
    print( $0 )
}

# Each block of lines between \begintt and \endtt is put
# into verbatim style, the lines are indented by 4 characters.
/^\\begintt/ {
    print( "% not executed example!\n\\begin{verbatim}" );
    getline
    while ( substr( $0, 1, 11 ) != "\\endtt" ) {
                    printf( "    %s\n", $0 )
                    getline
    }
    print( "\\end{verbatim} % not executed example" )
}

# Each block of lines between \beginexample and \endexample is put
# into verbatim style, the lines are indented by 4 characters.
/^\\beginexample/ {
    print( "\\begin{verbatim}" )
    getline
    while ( substr( $0, 1, 11 ) != "\\endexample" ) {
                    printf( "    %s\n", $0 )
                    getline
    }
    print( "\\end{verbatim}" )
}

# Text not contained in examples and enclosed in stars is set
# in boldface.
/\*/ {
    s = split( $0, sline, "\\" );
    k = 0;
    while ( k < s ) {
      k = k+1;
      if ( k > 1 && substr( sline[k], 1, 1 ) == "*" ) {
        printf( "*" );
        part = substr( sline[k], 2 )
      }
      else {
        part = sline[k]
        if ( k > 1 ) {
          printf( "\\" )
        }
      }
      r = split( part, line, "\*" );
      if ( r > 1 ) {
        if ( bf == 1 ) {
            printf( "%s}", line[1] );
            j = 3;
            bf = 0
        }
        else {
            j = 2
        }
        while ( j < r ) {
            printf( "%s{\\bf %s}", line[ j-1 ], line[j] );
            j = j+2
        }
        if ( j == r ) {
            printf( "%s{\\bf %s", line[ j-1 ], line[j] );
            bf = 1
        }
        else {
            printf( "%s", line[r] )
        }
      }
      else {
        printf( "%s", part )
      }
    }
    printf( "\n" )
}

END {
    # Check that no brackets are open.
    if ( bf == 1 ) {
        print( "still in boldface at end of file" ) > "/dev/stderr"
    }
}' < $1 > xpltmp


#############################################################################
##
##  Change singlequotes to verbatim,
##  but note that escaped singlequotes and doublequotes are ignored.
##
awk -f ../etc/xpl2latex.awk < xpltmp > $2
rm xpltmp


#############################################################################
##
#E

